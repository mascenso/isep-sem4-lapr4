@startuml
'https://plantuml.com/sequence-diagram

autonumber

actor Actor
activate Actor
note right of Actor: Existe um serviço com a responsabilidade de verificar a disponibilidade do professor no dia marcado e a propagação da lesson para a frequencia estipulada
participant CreateRecurringLessonUI as UI <<Presentation>>
participant CreateRecurringLessonController as Controller <<Application>>
participant RecurringLessonBuilder as Builder <<builder>>
participant PersistenceContext as Persistence <<persistence>>
participant RepositoryFactory as Factory <<factory>>
database RecurringLessonRepository as LessonRepository <<Repository>>
database TeacherRepository as TeacherRepository <<Repository>>
database CourseRepository as CourseRepository <<Repository>>
participant "serviço:RecurringLessonService" as Service <<Domain>>
participant "serviço:AuthorizationService" as Authz <<Domain>>
participant RecurringLesson as RecurringLesson <<Domain>>


Actor -> UI: CreateRecurringLesson()
activate UI
UI -> Controller: getTeacherCourses()
activate Controller
Controller -> UI: courses
UI -> Actor: selectorCourse.show()
Actor -> UI: Selects one of the courses
UI -> Actor: Ask User the recurring lesson information
Actor -> UI: inputs Recurring Lesson title, start date, start time\n end date, duration and frequency

UI -> Controller: createRecurringLesson(title, startDate, endDate, startTime, duration, frequency)

Controller -> Authz: session().get().authenticatedUser().username()
activate Authz
Authz -> Controller: username
deactivate Authz
Controller -> TeacherRepository: getCurrentTeacher()
activate TeacherRepository
TeacherRepository -> Controller: teacher
deactivate TeacherRepository
Controller -> CourseRepository: getTeacherCourses()
activate CourseRepository
CourseRepository -> Controller: courses
deactivate CourseRepository
Controller -> Service: generateRecurringLessons(startDate, endDate, frequency)
activate Service
Service -> Controller: List<Calendar> dayOfOccurrence
deactivate Service
Controller -> Builder: buildOrThrow()
activate Builder
Builder -> RecurringLesson: RecurringLesson(title, startDate, endDate, startTime, duration, frequency)
activate RecurringLesson
RecurringLesson -> Builder: recurringLesson
deactivate RecurringLesson
Builder -> Controller: recurringLesson
deactivate Builder
Controller -> Service: propagateLessonByFrequency(recurringLesson)
activate Service
Controller -> Service: validateRecurringLesson(teacher, recurringLesson)
deactivate Service
Controller -> Persistence: repositories()
activate Persistence
Persistence -> Factory: newInstance()
activate Factory
Factory -> Persistence: RecurringLesson
deactivate Factory
Persistence -> Controller: RecurringLesson
deactivate Persistence
Controller -> LessonRepository: save(recurringLesson)
activate LessonRepository
LessonRepository -> Controller: recurringLesson
deactivate LessonRepository
Controller -> UI: recurringLesson
deactivate Controller
Actor <- UI: back to menu


@enduml